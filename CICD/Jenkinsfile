env.module = "${JOB_NAME}".split('/')[0]
env.workspace = "mrchecker-framework-modules"
def hideTransfer = "-Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn"
pipeline{
	agent {docker {image 'marzepka/mrchecker:v1.1.2'}}
	stages{
		stage('Build'){
			steps{
				echo "Building module ${env.module} and it's dependency"
				sh """
				cd ${env.workspace}
				mvn clean compile package install -DskipTests=true --projects ${env.module} --also-make ${hideTransfer}
				"""
				//bulid this module and its dependencies deploy them to local repo
			}
		}
		stage('Test'){
			steps{
				echo "Testing ${env.module}"
				sh """
				cd ${env.workspace}
				mvn test --projects ${env.module} ${hideTransfer}
				"""
			}
		}
	}
	post{
		always{
			archiveArtifacts artifacts: "${env.workspace}/${env.module}/target/*.jar", fingerprint: true
			junit '**/surefire-reports/*.xml'
		}
	}
}
